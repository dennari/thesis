\documentclass[english,12pt]{article}

% LAYOUT
\usepackage{mylayout}
\setmainlanguage{english}
\usepackage{csquotes}
% replaces Helvetica in the cover page
\newfontfamily\texgyreheros[
	Path=/usr/share/texmf/fonts/opentype/public/tex-gyre/,
    Extension=.otf,
    UprightFont= *-regular,
    BoldFont=*-bold,
    ItalicFont=*-italic,
    BoldItalicFont=*-bolditalic,
    Mapping={tex-text}
]{texgyreheros}

\usepackage{aaltothesis}
\usepackage[
shadow,
textsize=footnotesize,
textwidth=2.7cm,
backgroundcolor=orange!40,
linecolor=orange!40,
colorinlistoftodos
]{todonotes}

% PDF SETUP
\usepackage[unicode,bookmarks, colorlinks, breaklinks,
pdftitle={Dippa},
pdfauthor={Ville Väänänen},
pdfproducer={xetex}
]{hyperref}
\hypersetup{linkcolor=black,citecolor=black,filecolor=black,urlcolor=MidnightBlue}
%\usepackage{mcode}

%\usepackage[shadow]{todonotes}
% MATH
\usepackage{mymath}
\usepackage{amsthm}
\usepackage{enumerate}
\usepackage{xfrac}
%\everymath{\displaystyle}

\usepackage{tikz}
\usetikzlibrary{arrows}
\usepackage{showlabels}

\newcommand{\yk}{\v{y}_{k}}
\newcommand{\y}{\v{y}}
\newcommand{\ykk}{\v{y}_{k-1}}
\newcommand{\xk}{\v{x}_{k}}
\newcommand{\x}{\v{x}}
\newcommand{\X}{\x_{1:T}}
\newcommand{\XX}{\v{X}}
\newcommand{\Y}{\y_{1:T}}
\newcommand{\YY}{\v{Y}}
\newcommand{\z}{\v{z}}
\newcommand{\h}{\v{h}}
\newcommand{\f}{\v{f}}
\newcommand{\g}{\v{g}}
\newcommand{\p}{\v{p}}
\newcommand{\q}{\v{q}}

\renewcommand{\P}{\v{P}}
\renewcommand{\m}{\v{m}}
\newcommand{\xkk}{\v{x}_{k-1}}
\newcommand{\tr}{\mathsf{T}}
\newcommand{\Th}{\gv{\theta}}
\NewDocumentCommand\lLH{O{\Th}}{\F[\big]{\ell}{#1}}
\NewDocumentCommand\score{}{\nabla\lLH}
%\newcommand{\LHf}[1]{\Pdf{\X}{#1}}
%\newcommand{\LHh}{\Pdf{\X}{\hat{\Th}}}
%\newcommand{\lLH}{\ell\!\left(\Th\right)}
%\newcommand{\cLH}{\Pdf{\X,\Y}{\Th}}
%\newcommand{\lcLH}{\log\cLH}
\newcommand{\tP}{q}
\NewDocumentCommand\tPX{G{\gv{\psi}}}{\Pdf[\tP]{\X}{#1}}
\NewDocumentCommand\post{G{\Th}}{\Pdf[p]{\X}{\Y,#1}}
\NewDocumentCommand\cLH{G{\Th}}{\Pdf{\X,\Y}{#1}}
\NewDocumentCommand\LH{G{\Th}}{\Pdf{\Y}{#1}}
%\NewDocumentCommand\lcLH{O{0pt}}{\log\cLH[#1]}
\NewDocumentCommand\EMQ{o G{\Th'} G{\Th}}{
	\IfNoValueTF{#1}
		{\F{\mathcal Q}{#3,#2}}
		{\F[#1]{\mathcal Q}{#3,#2}}
}
\NewDocumentCommand\EMH{G{\Th'} G{\Th}}{\F{\mathcal H}{#2,#1}}
\NewDocumentCommand\EMB{G{\Th'} G{\Th}}{\F{\mathcal B}{#2,#1}}
\NewDocumentCommand\EMM{s O{} G{\Th}}{
	\IfBooleanTF{#1}
		{\v{M}}
		{\F{\v{M}#2}{#3}}
}
\newcommand{\KL}[2]{\mathrm{KL}\fparenmid*{#1}{#2}{\Vert}}

\NewDocumentCommand\dQ{O{2} O{0} G{\Th_\star} G{\Th_\star}}{
	\nabla^#1\EMQ{#4}{#3}
}
\NewDocumentCommand\dH{O{2} O{0} G{\Th_\star} G{\Th_\star}}{
	\nabla^#1\EMH{#4}{#3}
}
\NewDocumentCommand\dL{O{2} O{0} G{\Th_\star}}{
	\nabla^#1\lLH[#3]
}
\NewDocumentCommand\prtdd{m G{\Th} g}{
	\IfNoValueTF{#3}
		{\dpd[2]{#1}{#2}}
		{\dmd{#1}{2}{#2}{}{\left.\mkern-2mu #3^\tr \right.}{}}
}
\newtheorem{theorem}{Theorem}
\newtheorem{proposition}{Proposition}
\newtheorem{lemma}{Lemma}
\theoremstyle{definition}
\newtheorem{example}{Example}

% BIBLIOGRAPHY
\usepackage[style=authoryear-comp,backend=biber]{biblatex} % TEXLIPSE BUG: backend cannot be first
\addbibresource{Dippa.bib}
\ExecuteBibliographyOptions{ % use this to override options set by the style
uniquename=false,
uniquelist=minyear,
maxcitenames=1,
url=false,
firstinits=true
}

\setlength{\hoffset}{-1in}
\setlength{\oddsidemargin}{35mm}
\setlength{\evensidemargin}{25mm}
\setlength{\textwidth}{15cm}
\setlength{\voffset}{-1in}
\setlength{\headsep}{7mm}
\setlength{\headheight}{1em}
\setlength{\topmargin}{25mm-\headheight-\headsep}
\setlength{\textheight}{23cm}

\begin{document}

\input{coverpage}
\makecoverpage



%\input{abstract}
%\newpage


\addcontentsline{toc}{section}{Contents}
\tableofcontents

%\input{abbr}


%% Sivulaskurin viilausta opinnäytteen vaatimusten mukaan:
%% Aloitetaan sivunumerointi arabialaisilla numeroilla (ja jätetään
%% leipätekstin ensimmäinen sivu tyhjäksi, 
%% ks. alla \thispagestyle{empty}).
%% Pakotetaan lisäksi ensimmäinen varsinainen tekstisivu alkamaan 
%% uudelta sivulta clearpage-komennolla. 
%% clearpage on melkein samanlainen kuin newpage, mutta 
%% flushaa myös LaTeX:n floatit 
%% 
%% Corrects the page numbering, there is no need to change these
\cleardoublepage
\storeinipagenumber
\pagenumbering{arabic}
\setcounter{page}{1}


\section{Introduction}
\input{introduction}


%% Leave first page empty
\thispagestyle{empty}


\clearpage

\section{Background}
\input{background}



\section{State estimation}
\input{state_est}

\section{Parameter estimation}
\input{parameter_est}


\section{Results}
\input{results}

\section{Conclusion}
\input{discussion}

	
\clearpage
\listoftodos
\clearpage
\appendix
\numberwithin{equation}{section}
\numberwithin{lemma}{section}
\section{Additional material}
\subsection{Properties of the Gaussian distribution}
\begin{lemma} \label{lemma:gaussian_joint}
Suppose $\x\in\R^n$ and $\y\in\R^m$ have the distributions
\begin{align*}
	\Pdf{\x}&= \N[\x]{\v{m}}{\v{P}} \\
	\Pdf{\y}{\x}&= \N[\y]{\v{H}\x+\v{u}}{\v{R}}.
\end{align*}
Then the joint distribution is
\begin{align*}
	\Pdf{\begin{bmatrix}
		\x\\
		\y
	\end{bmatrix}}&=
	\N[\bm{\x\\\y}]{
	\begin{bmatrix}
		\v{m}\\
		\v{H}\v{m}+\v{u}
	\end{bmatrix}
	}{
	\begin{bmatrix}
		\v{P}&\v{P}\v{H}^\tr\\
		\v{H}\v{P}&\v{H}\v{P}\v{H}^\tr+\v{R}\\
	\end{bmatrix}
	}
\end{align*}
\end{lemma}
\begin{proof}
\begin{align}
	\E{\y}&=\defint{}{}{\y\,\Pdf{\y}}{\y} \nonumber\\
	&=\defint{}{}{\y\Big(\!\defint{}{}{\Pdf{\y}{\x}\Pdf{\x}}{\x}\Big)}{\y}\nonumber\\
	&\mbox{{\small (change the order of integration according to Fubini's theorem)}}\nonumber\\
	&=\E{\E{\y\mid\x}}\\
	%&=\defint{}{}{\fparen*{\v{H}\x+\v{u}}\Pdf{\x}}{\x}\label{eq:mean_int},\\
	&=\v{H}\v{m}+\v{u}\\
%\end{align}
%\begin{align}
	\var{\y}&=\defint{}{}{\fparen*{\y-\E{\y}}\fparen*{\y-\E{\y}}^\tr\Pdf{\y}{\x}\Pdf{\x}}{\y}{\x} \nonumber\\
	%&=\defint{}{}{\fparen*{\y-\E{\y}}\fparen*{\y-\E{\y}}^\tr\defint{}{}{\Pdf{\y}{\x}\Pdf{\x}}{\y}}{\x} \nonumber\\
	&=\E{\E{\y\mid\x}\E{\y\mid\x}^\tr}-\E{\E{\y\mid\x}}\E{\E{\y\mid\x}}^\tr \nonumber \\
&\quad+\defint{}{}{\fparen*{\y-\E{\y\mid\x}}\fparen*{\y-\E{\y\mid\x}}^\tr\Pdf{\y}{\x}\Pdf{\x}}{\y}{\x} \nonumber \\
	&= \var{\E{\y\mid\x}}+\E{\var{\y\mid\x}}\\
	&= \v{H}\v{P}\v{H}^\tr+\v{R}\\
%\end{align}
%\begin{align}
	\cov{\x}{\y}&=\defint{}{}{\fparen[\big]{\x-\E{\x}}\fparen[\big]{\y-\E{\y}}^\tr\Pdf{\x}\Pdf{\y}{\x}}{\x}{\y} \nonumber\\
	&=\defint{}{}{\fparen[\big]{\x-\E{\x}}\fparen[\big]{\E{\y\mid\x}-\E{\y}}^\tr\Pdf{\x}}{\x} \nonumber\\
	&=\defint{}{}{\fparen[\big]{\x-\v{m}}\fparen[\big]{\x-\v{m}}^\tr\v{H}^\tr\Pdf{\x}}{\x} \nonumber\\
	&=\v{P}\v{H}^\tr
\end{align}%

\end{proof}
\begin{lemma} \label{lemma:gaussian_cond}
Suppose $\x\in\R^n$ and $\y\in\R^m$ have the joint distribution
\begin{align*}
	\Pdf{\begin{bmatrix}
		\x\\
		\y
	\end{bmatrix}}&=
	\N[\bm{\x\\\y}]{
	\begin{bmatrix}
		\v{a}\\
		\v{b}
	\end{bmatrix}
	}{
	\begin{bmatrix}
		\v{A}&\v{C}\\
		\v{C}^\tr&\v{B}
	\end{bmatrix}
	}.
\end{align*}
Then the marginal and conditional distributions are given by
\begin{align*}
	\Pdf{\x} &= \N[\x]{\v{a}}{\v{A}}\\
	\Pdf{\y} &= \N[\x]{\v{b}}{\v{B}}\\
	\Pdf{\x}{\y}&= \N[\x][\displaystyle]{\v{a}+\v{C}\v{B}^{-1}\fparen*{\v{y}-\v{b}}}{\v{A}-\v{C}\v{B}^{-1}\v{C}^\tr}\\
	\Pdf{\y}{\x}&= \N[\x][\displaystyle]{\v{b}+\v{C}^\tr\v{A}^{-1}\fparen*{\v{x}-\v{a}}}{\v{B}-\v{C}^\tr\v{A}^{-1}\v{C}}
\end{align*}
\end{lemma}
\clearpage
\printbibliography
\end{document}

